<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å˜èªå¸³ãã‚“</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; }
        :root, .theme-light {
            --bg-color: #f1f5f9; /* slate-100 */
            --header-bg-color: #ffffff;
            --card-bg-color: #ffffff;
            --text-color: #1e293b;
            --text-color-secondary: #64748b;
            --header-text-color: #1e293b;
            --primary-color: #0ea5e9; /* sky-500 */
            --primary-color-rgb: 14, 165, 233;
            --primary-text-color: #ffffff;
            --border-color: #e2e8f0; /* slate-200 */
            --danger-color: #ef4444;
            --danger-color-rgb: 239, 68, 68;
            --success-color: #22c55e;
            --success-color-rgb: 34, 197, 94;
            --success-bg-color: #f0fdf4;
            --danger-bg-color: #fef2f2;
            --icon-back-card-color: #cbd5e1;
            --footer-button-sub-hover-bg: #0ea5e9;
        }
        .theme-dark {
            --bg-color: #0f172a;
            --header-bg-color: #1e293b;
            --card-bg-color: #334155;
            --text-color: #e2e8f0;
            --text-color-secondary: #94a3b8;
            --header-text-color: var(--text-color);
            --primary-color: #f97316;
            --primary-color-rgb: 249, 115, 22;
            --primary-text-color: #ffffff;
            --border-color: #475569;
            --danger-color: #fca5a5;
            --danger-color-rgb: 252, 165, 165;
            --success-color: #86efac;
            --success-color-rgb: 134, 239, 172;
            --success-bg-color: #166534;
            --danger-bg-color: #7f1d1d;
            --icon-back-card-color: #e2e8f0;
            --footer-button-sub-hover-bg: #f97316;
        }
        .theme-sakura {
            --bg-color: #fdf2f8;
            --header-bg-color: #ffffff;
            --card-bg-color: #ffffff;
            --text-color: #832c56;
            --text-color-secondary: #be185d;
            --header-text-color: #832c56;
            --primary-color: #ec4899;
            --primary-color-rgb: 236, 72, 153;
            --primary-text-color: #ffffff;
            --border-color: #fbcfe8;
            --icon-back-card-color: #f9a8d4;
            --footer-button-sub-hover-bg: #db2777; 
        }
        .theme-matcha {
             --bg-color: #f7fee7;
            --header-bg-color: #ffffff;
            --card-bg-color: #ffffff;
            --text-color: #1a2e05;
            --text-color-secondary: #3f6212;
            --header-text-color: #1a2e05;
            --primary-color: #4d7c0f;
            --primary-color-rgb: 77, 124, 15;
            --primary-text-color: #ffffff;
            --border-color: #dcfce7;
            --icon-back-card-color: #a3e635;
            --footer-button-sub-hover-bg: #65a30d; 
        }
        .theme-mizu {
            --bg-color: #ecfeff;
            --header-bg-color: #ffffff;
            --card-bg-color: #ffffff;
            --text-color: #1e3a8a;
            --text-color-secondary: #1d4ed8;
            --header-text-color: #1e3a8a;
            --primary-color: #06b6d4;
            --primary-color-rgb: 6, 182, 212;
            --primary-text-color: #ffffff;
            --border-color: #a5f3fc;
            --icon-back-card-color: #67e8f9;
            --footer-button-sub-hover-bg: #0891b2; 
        }
        .theme-yuyake {
            --bg-color: #2c244d;
            --header-bg-color: #312e81;
            --card-bg-color: #4338ca;
            --text-color: #ddd6fe;
            --text-color-secondary: #a5b4fc;
            --header-text-color: var(--text-color);
            --primary-color: #f59e0b;
            --primary-color-rgb: 245, 158, 11;
            --primary-text-color: #ffffff;
            --border-color: #4f46e5;
            --icon-back-card-color: #e2e8f0;
            --footer-button-sub-hover-bg: #f59e0b;
        }
        .modal, .screen { transition: opacity 0.25s ease; }
        .hidden { display: none; }
        .flashcard-inner { transition: transform 0.6s; transform-style: preserve-3d; }
        .flashcard.is-flipped .flashcard-inner { transform: rotateY(180deg); }
        .flashcard-front, .flashcard-back { 
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
        }
        .flashcard-back { transform: rotateY(180deg); }
        #toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; pointer-events: none; }
        .toast { background-color: rgba(0,0,0,0.7); color: white; padding: 10px 20px; border-radius: 20px; margin-bottom: 10px; opacity: 0; transition: opacity 0.5s; }
        .toast.show { opacity: 1; }

        .footer-button {
            transition: background-color 0.2s, color 0.2s;
        }
        .footer-button.sub {
            background-color: rgba(var(--primary-color-rgb), 0.15);
            color: var(--primary-color);
        }
        .theme-light .footer-button.sub,
        .theme-sakura .footer-button.sub,
        .theme-matcha .footer-button.sub,
        .theme-mizu .footer-button.sub {
             background-color: var(--border-color);
             color: var(--text-color-secondary);
        }
        .footer-button.sub:hover, .footer-button.sub:active {
            background-color: var(--footer-button-sub-hover-bg);
            color: var(--primary-text-color);
        }
        #unfamiliar-button, #familiar-button {
             backdrop-filter: blur(8px);
        }
        #unfamiliar-button {
             background-color: rgba(var(--danger-color-rgb), 0.1);
        }
        #familiar-button {
             background-color: rgba(var(--success-color-rgb), 0.1);
        }
        /* --- è¨­å®šç”»é¢ æ–°ãƒ‡ã‚¶ã‚¤ãƒ³ --- */
        #settings-screen main { background-color: var(--bg-color); }
        .settings-card {
            background-color: var(--card-bg-color);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .settings-card h3 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-color-secondary);
            margin-bottom: 0.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
        }
        .settings-card > .settings-row:last-child,
        .accordion-content > .settings-row:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }
        .settings-card > div > .settings-row:first-of-type {
            padding-top: 0;
        }
        .settings-label {
            font-size: 0.95rem;
            color: var(--text-color);
            font-weight: 500;
        }
        .custom-toggle {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }
        .custom-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .custom-toggle .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1;
            transition: .4s;
            border-radius: 24px;
        }
        .custom-toggle .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .custom-toggle input:checked + .slider {
            background-color: var(--primary-color);
        }
        .custom-toggle input:checked + .slider:before {
            transform: translateX(20px);
        }
        .sliding-pill-control-wrapper {
            overflow-x: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .sliding-pill-control-wrapper::-webkit-scrollbar {
            display: none;
        }
        .sliding-pill-control {
            display: inline-flex;
            position: relative;
            background-color: var(--border-color);
            border-radius: 999px;
            padding: 4px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.06);
        }
        .sliding-pill-control .option {
            padding: 0.5rem 1rem;
            cursor: pointer;
            color: var(--text-color-secondary);
            font-weight: 500;
            transition: color 0.3s ease-in-out;
            z-index: 10;
            position: relative;
            border: none;
            background: transparent;
            white-space: nowrap;
        }
        .sliding-pill-control .option.selected {
            color: var(--primary-text-color);
        }
        .sliding-pill-control .pill {
            position: absolute;
            top: 4px;
            left: 0;
            width: 0;
            height: calc(100% - 8px);
            background: var(--primary-color);
            border-radius: 999px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.12);
            transition: all 0.4s cubic-bezier(0.22, 1, 0.36, 1);
        }
        .sub-settings-panel {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, margin 0.5s ease-in-out, padding 0.5s ease-in-out, border-top-width 0.1s linear 0.4s;
            margin-top: 0;
            padding-top: 0;
            border-top: 0px solid transparent;
        }
        .sub-settings-panel.active {
            max-height: 1000px; /* ååˆ†ãªé«˜ã•ã‚’ç¢ºä¿ */
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
             transition: max-height 0.5s ease-in-out, margin 0.5s ease-in-out, padding 0.5s ease-in-out, border-top-width 0.1s linear;
        }
        .accordion-header { cursor: pointer; }
        .accordion-header .chevron { transition: transform 0.3s ease; }
        .accordion-header.open .chevron { transform: rotate(180deg); }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out, padding-top 0.4s ease-out;
            padding-top: 0;
        }
        .accordion-content.open {
            max-height: 500px;
            padding-top: 0.5rem;
        }
        .accordion-content .settings-row { padding-left: 1rem; }
    </style>
</head>
<body class="bg-[var(--bg-color)] text-[var(--text-color)]">
    
    <div id="toast-container"></div>

    <!-- ãƒ›ãƒ¼ãƒ ç”»é¢ -->
    <div id="home-screen" class="screen">
        <header class="bg-[var(--header-bg-color)] shadow-md sticky top-0 z-10">
            <div class="container mx-auto px-4 h-16 flex justify-between items-center"><h1 class="text-xl font-bold text-[var(--header-text-color)]">å˜èªå¸³ãã‚“</h1><button id="settings-button" class="text-[var(--header-text-color)] hover:opacity-75 p-2 rounded-full transition-opacity"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg></button></div>
        </header>
        <main class="container mx-auto p-4 pb-24 flex-grow">
            <section class="mb-8">
                <h2 class="text-lg font-bold text-[var(--primary-color)] mb-2">â–¼ æœ¬æ—¥ã®ãŠã™ã™ã‚</h2>
                <div id="recommend-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"><p id="recommend-loading" class="text-[var(--text-color-secondary)] col-span-full">å¾©ç¿’ã™ã‚‹ã‚«ãƒ¼ãƒ‰ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p></div>
            </section>
            <section>
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-lg font-bold text-[var(--primary-color)]">â–¼ ã™ã¹ã¦ã®å˜èªå¸³</h2>
                    <div class="relative w-1/2 sm:w-1/3">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-[var(--text-color-secondary)]"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg></span>
                        <input type="text" id="search-bar" placeholder="æ¤œç´¢..." class="w-full pl-10 pr-3 py-2 bg-[var(--card-bg-color)] border border-[var(--border-color)] rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--primary-color)]">
                    </div>
                </div>
                <div id="deck-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"><p id="deck-loading" class="text-[var(--text-color-secondary)] col-span-full">èª­ã¿è¾¼ã¿ä¸­...</p></div>
            </section>
        </main>
        <footer class="fixed bottom-0 left-0 right-0 bg-[var(--header-bg-color)] border-t border-[var(--border-color)]">
            <div class="container mx-auto px-4 h-20 flex justify-around items-center">
                <div class="flex flex-col items-center"><label class="text-xs text-[var(--header-text-color)] mb-1">å‡ºé¡Œ</label><button id="toggle-direction" class="footer-button sub p-2 rounded-full w-14 h-14 flex items-center justify-center"></button></div>
                <div class="flex flex-col items-center"><label class="text-xs text-[var(--header-text-color)] mb-1">ãƒ¢ãƒ¼ãƒ‰</label><button id="toggle-mode" class="footer-button sub p-2 rounded-full w-14 h-14 flex items-center justify-center"></button></div>
                <button id="add-deck-button" class="bg-[var(--primary-color)] text-[var(--primary-text-color)] rounded-full w-14 h-14 text-4xl font-light flex items-center justify-center shadow-lg hover:opacity-80 transition-opacity">+</button>
            </div>
        </footer>
    </div>
    <!-- å˜èªå¸³è©³ç´°ç”»é¢ -->
    <div id="deck-screen" class="screen hidden">
        <header class="bg-[var(--header-bg-color)] shadow-md sticky top-0 z-10">
            <div class="container mx-auto px-4 h-16 flex justify-between items-center">
                <button id="back-to-home-button" class="p-2 rounded-full hover:bg-black/10 text-[var(--header-text-color)] transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
                <h1 id="deck-title-header" class="text-xl font-bold text-[var(--header-text-color)] truncate"></h1>
                <div class="flex items-center gap-4">
                    <button id="csv-import-button" class="text-sm font-semibold border border-current rounded-full px-3 py-1 hover:bg-black/10 text-[var(--header-text-color)] transition-colors">CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                    <input type="file" id="csv-file-input" accept=".csv" class="hidden">
                    <button class="text-[var(--danger-color)] hover:opacity-75 transition-opacity" id="delete-deck-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg></button>
                </div>
            </div>
        </header>
        <main class="container mx-auto p-4 pb-24 flex-grow">
            <div id="tag-filter-bar" class="flex flex-wrap gap-2 mb-4"></div>
            <div id="card-list-container"></div>
        </main>
        <footer class="fixed bottom-0 left-0 right-0 bg-[var(--header-bg-color)] border-t border-[var(--border-color)]">
            <form id="add-card-form" class="container mx-auto px-4 h-16 flex items-center gap-2">
                <input type="text" id="new-card-front" placeholder="ã‚ªãƒ¢ãƒ†" class="flex-1 w-full px-3 py-2 bg-[var(--bg-color)] border border-[var(--border-color)] rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--primary-color)]">
                <input type="text" id="new-card-back" placeholder="ã‚¦ãƒ©" class="flex-1 w-full px-3 py-2 bg-[var(--bg-color)] border border-[var(--border-color)] rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--primary-color)]">
                <button type="submit" class="px-4 py-2 bg-[var(--primary-color)] text-[var(--primary-text-color)] rounded-lg font-bold">è¿½åŠ </button>
            </form>
        </footer>
    </div>
    <!-- å­¦ç¿’ç”»é¢ -->
    <div id="study-screen" class="screen hidden flex flex-col h-screen">
         <header class="bg-[var(--header-bg-color)] container mx-auto px-4 h-16 flex items-center gap-4 flex-shrink-0">
             <div id="study-progress" class="text-lg font-mono text-[var(--header-text-color)]"></div>
             <button id="exit-study-button" class="ml-auto p-2 rounded-full hover:bg-black/10 text-[var(--header-text-color)] transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
        </header>
        <main id="study-main-content" class="container mx-auto p-4 flex-grow flex flex-col items-center">
            <!-- ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰ -->
            <div id="flashcard-mode" class="w-full max-w-md flex-grow flex flex-col items-center justify-center">
                <div class="flashcard aspect-[4/3] perspective-[1000px] w-full mb-4">
                    <div id="flashcard-inner" class="flashcard-inner relative w-full h-full cursor-pointer">
                        <div id="flashcard-front" class="flashcard-front absolute w-full h-full bg-[var(--card-bg-color)] shadow-lg rounded-xl text-3xl md:text-4xl text-center"></div>
                        <div id="flashcard-back" class="flashcard-back absolute w-full h-full bg-[var(--card-bg-color)] shadow-lg rounded-xl text-3xl md:text-4xl text-center"></div>
                    </div>
                </div>
                 <div id="flashcard-controls" class="w-full flex justify-around items-center gap-4 mt-auto h-24 flex-shrink-0">
                    <button id="unfamiliar-button" class="flex flex-col items-center justify-center h-20 w-20 rounded-full border-2 border-[var(--danger-color)] text-[var(--danger-color)] font-bold shadow-sm" style="background-color: rgba(var(--danger-color-rgb), 0.1); backdrop-filter: blur(8px);"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg><span class="mt-1 text-xs">ã‚ã‹ã‚‰ãªã„</span></button>
                    <button id="familiar-button" class="flex flex-col items-center justify-center h-20 w-20 rounded-full border-2 border-[var(--success-color)] text-[var(--success-color)] font-bold shadow-sm" style="background-color: rgba(var(--success-color-rgb), 0.1); backdrop-filter: blur(8px);"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg><span class="mt-1 text-xs">ã‚ã‹ã£ãŸ</span></button>
                 </div>
                 <button id="flashcard-speak-button" class="mt-4 text-4xl text-[var(--text-color-secondary)] hover:opacity-80 transition-opacity"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg></button>
            </div>
             <!-- ã‚¯ã‚¤ã‚ºãƒ¢ãƒ¼ãƒ‰ -->
            <div id="quiz-mode" class="w-full max-w-md h-full flex-col hidden">
                <div id="quiz-question" class="w-full text-center text-3xl md:text-4xl font-semibold mb-8 cursor-pointer"></div>
                <div id="quiz-options" class="grid grid-cols-1 gap-4 w-full"></div>
            </div>
        </main>
    </div>
    <!-- è¨­å®šç”»é¢ -->
    <div id="settings-screen" class="screen hidden">
        <header class="bg-[var(--header-bg-color)] shadow-md sticky top-0 z-10">
            <div class="container mx-auto px-4 h-16 flex items-center">
                <button id="back-to-home-from-settings" class="p-2 rounded-full hover:bg-black/10 text-[var(--header-text-color)] transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
                <h1 class="text-xl font-bold text-[var(--header-text-color)]">è¨­å®š</h1>
            </div>
        </header>
        <main class="container mx-auto p-4">
            <div class="settings-card">
                <h3>ä¸€èˆ¬</h3>
                <div class="settings-row">
                    <span class="settings-label">ãƒ†ãƒ¼ãƒ</span>
                    <div class="sliding-pill-control-wrapper">
                        <div id="theme-selector" class="sliding-pill-control">
                             <div class="pill"></div>
                             <button class="option" data-value="theme-light">Paper</button>
                             <button class="option" data-value="theme-dark">Midnight</button>
                             <button class="option" data-value="theme-sakura">Sakura</button>
                             <button class="option" data-value="theme-matcha">Matcha</button>
                             <button class="option" data-value="theme-mizu">Ocean</button>
                             <button class="option" data-value="theme-yuyake">Twilight</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="settings-card">
                <h3>å­¦ç¿’è¨­å®š</h3>
                <div class="settings-row">
                    <span class="settings-label">å‡ºé¡Œæ•°</span>
                    <div id="question-count-buttons" class="sliding-pill-control">
                        <div class="pill"></div>
                        <button class="option" data-value="10">10å•</button>
                        <button class="option" data-value="20">20å•</button>
                        <button class="option" data-value="50">50å•</button>
                        <button class="option" data-value="all">ã™ã¹ã¦</button>
                    </div>
                </div>
            </div>
            <!-- éŸ³å£°èª­ã¿ä¸Šã’è¨­å®š -->
            <div id="speech-settings-card" class="settings-card">
                <h3>éŸ³å£°èª­ã¿ä¸Šã’</h3>
                <div class="settings-row">
                    <label for="speech-enabled-toggle" class="settings-label">éŸ³å£°èª­ã¿ä¸Šã’ã‚’æœ‰åŠ¹ã«ã™ã‚‹</label>
                    <label class="custom-toggle">
                        <input type="checkbox" id="speech-enabled-toggle">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="sub-settings-panel">
                    <div class="settings-row">
                         <label for="quiz-answer-speak-toggle" class="settings-label">è§£ç­”ã‚’èª­ã¿ä¸Šã’ã‚‹</label>
                         <label class="custom-toggle">
                             <input type="checkbox" id="quiz-answer-speak-toggle">
                             <span class="slider"></span>
                         </label>
                    </div>
                    <div class="accordion-header settings-row" data-target="accordion-en">
                        <span class="settings-label">è‹±èªã®éŸ³å£°è¨­å®š</span>
                        <span class="chevron text-gray-400">â–¼</span>
                    </div>
                    <div id="accordion-en" class="accordion-content">
                        <div class="settings-row">
                            <label for="en-voice-select" class="settings-label">éŸ³å£°ã®ç¨®é¡</label>
                            <select id="en-voice-select" class="w-1/2 p-2 rounded-lg border border-[var(--border-color)] bg-[var(--bg-color)]"></select>
                        </div>
                         <div class="settings-row">
                            <label for="en-rate-slider" class="settings-label">é€Ÿåº¦: <span id="en-rate-value">1.0</span></label>
                            <input type="range" id="en-rate-slider" min="0.5" max="2" step="0.1" value="1" class="w-1/2">
                        </div>
                    </div>
                    <div class="accordion-header settings-row" data-target="accordion-ja">
                        <span class="settings-label">æ—¥æœ¬èªã®éŸ³å£°è¨­å®š</span>
                        <span class="chevron text-gray-400">â–¼</span>
                    </div>
                     <div id="accordion-ja" class="accordion-content">
                        <div class="settings-row">
                            <label for="ja-voice-select" class="settings-label">éŸ³å£°ã®ç¨®é¡</label>
                            <select id="ja-voice-select" class="w-1/2 p-2 rounded-lg border border-[var(--border-color)] bg-[var(--bg-color)]"></select>
                        </div>
                         <div class="settings-row">
                            <label for="ja-rate-slider" class="settings-label">é€Ÿåº¦: <span id="ja-rate-value">1.0</span></label>
                            <input type="range" id="ja-rate-slider" min="0.5" max="2" step="0.1" value="1" class="w-1/2">
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <!-- æ–°è¦å˜èªå¸³ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="add-deck-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 opacity-0 pointer-events-none">
        <div class="bg-[var(--card-bg-color)] rounded-lg p-6 w-full max-w-sm shadow-xl">
            <h3 class="text-xl font-bold mb-4">æ–°ã—ã„å˜èªå¸³ã‚’ä½œæˆ</h3>
            <input type="text" id="new-deck-title-input" placeholder="å˜èªå¸³ã®ã‚¿ã‚¤ãƒˆãƒ«" class="w-full px-3 py-2 border border-[var(--border-color)] rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-[var(--primary-color)]">
            <div class="flex justify-end gap-2">
                <button id="cancel-add-deck" class="px-4 py-2 rounded-lg">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="confirm-add-deck" class="px-4 py-2 bg-[var(--primary-color)] text-[var(--primary-text-color)] rounded-lg hover:opacity-80 transition-colors">ä½œæˆ</button>
            </div>
        </div>
    </div>
    <!-- ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="confirm-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 opacity-0 pointer-events-none">
        <div class="bg-[var(--card-bg-color)] rounded-lg p-6 w-full max-w-sm shadow-xl">
            <h3 id="confirm-modal-title" class="text-lg font-bold mb-4"></h3>
            <div class="flex justify-end gap-2">
                <button id="confirm-modal-cancel" class="px-4 py-2 rounded-lg">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="confirm-modal-ok" class="px-4 py-2 bg-[var(--danger-color)] text-white rounded-lg">OK</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { openDB } from 'https://unpkg.com/idb@7.1.1/build/index.js';
        
        // --- ã‚¢ãƒ—ãƒªã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ ---
        document.addEventListener('DOMContentLoaded', initializeApp);

        // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ãƒ†ãƒ¼ãƒˆ ---
        let db;
        const state = {
            allDecksCache: [],
            currentDeckId: null,
            currentDeckCards: [],
            currentTagFilter: null,
            studySession: { cards: [], currentIndex: 0, deckId: null, correctAnswers: 0, startTime: 0, isAnswered: false },
            uiSettings: { 
                theme: 'theme-light', 
                learningMode: 'card', 
                cardDirection: 'front',
                speechEnabled: true, 
                questionCount: 'all',
                enRate: 1.0,
                enVoice: null,
                jaRate: 1.0,
                jaVoice: null,
                quizAnswerReadAloud: false,
            }
        };

        // --- DOMè¦ç´  ---
        const dom = {};
        
        // --- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ (IndexedDB) ãƒ©ãƒƒãƒ‘ãƒ¼ ---
        const DB_NAME = 'tangochokun-db';
        const DB_VERSION = 1;
        const DECK_STORE = 'decks';
        const CARD_STORE = 'cards';
        
        const dbOps = {
            async initDB() {
                db = await openDB(DB_NAME, DB_VERSION, {
                    upgrade(db) {
                        if (!db.objectStoreNames.contains(DECK_STORE)) {
                            db.createObjectStore(DECK_STORE, { keyPath: 'id', autoIncrement: true });
                        }
                        if (!db.objectStoreNames.contains(CARD_STORE)) {
                            const store = db.createObjectStore(CARD_STORE, { keyPath: 'id', autoIncrement: true });
                            store.createIndex('deckId', 'deckId', { unique: false });
                        }
                    },
                });
            },
            async getDecks() { return await db.getAll(DECK_STORE); },
            async getDeck(id) { return await db.get(DECK_STORE, id); },
            async addDeck(deck) { return await db.add(DECK_STORE, deck); },
            async updateDeck(deck) { return await db.put(DECK_STORE, deck); },
            async getAllCards() { return await db.getAll(CARD_STORE); },
            async getCardsByDeck(deckId) { return await db.getAllFromIndex(CARD_STORE, 'deckId', deckId); },
            async getCard(id) { return await db.get(CARD_STORE, id); },
            async addCard(card) { return await db.add(CARD_STORE, card); },
            async deleteCard(cardId) { return await db.delete(CARD_STORE, cardId); },
            async updateCard(card) { return await db.put(CARD_STORE, card); },
            async deleteDeck(deckId) {
                const tx = db.transaction([DECK_STORE, CARD_STORE], 'readwrite');
                const cardStore = tx.objectStore(CARD_STORE);
                const cardIndex = cardStore.index('deckId');
                const cardsToDelete = await cardIndex.getAllKeys(deckId);
                await Promise.all([
                    ...cardsToDelete.map(key => cardStore.delete(key)),
                    tx.objectStore(DECK_STORE).delete(deckId)
                ]);
                await tx.done;
            }
        };

        // --- UIãƒ»ãƒ­ã‚¸ãƒƒã‚¯ã®ã‚³ã‚¢é–¢æ•° ---
        const showScreen = (screenName) => {
             speechSynthesis.cancel();
             Object.values(dom.screens).forEach(s => s.classList.add('hidden'));
             const targetScreen = document.getElementById(`${screenName}-screen`);
             if(targetScreen) targetScreen.classList.remove('hidden');
        }

        const showToast = (message, duration = 3000) => {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            toastContainer.appendChild(toast);
            setTimeout(() => { toast.classList.add('show'); }, 10);
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, duration);
        }

        const loadSettings = () => {
            Object.keys(state.uiSettings).forEach(key => {
                const savedValue = localStorage.getItem(key);
                if (savedValue) {
                    if (key.includes('Rate')) {
                        state.uiSettings[key] = parseFloat(savedValue);
                    } else if (typeof state.uiSettings[key] === 'boolean') {
                        state.uiSettings[key] = savedValue === 'true';
                    } else {
                        state.uiSettings[key] = savedValue;
                    }
                }
            });
            updateTheme();
            updateModeButton();
            updateDirectionButton();
        }
        
        const saveSetting = (key, value) => {
            state.uiSettings[key] = value;
            localStorage.setItem(key, value);
        }
        
        const updateTheme = () => { 
            document.body.className = `bg-[var(--bg-color)] text-[var(--text-color)]`;
            document.body.classList.add(state.uiSettings.theme);
        }
        const updateModeButton = () => { dom.toggleMode.innerHTML = state.uiSettings.learningMode === 'card' ? '<svg viewBox="0 0 70 60" class="w-8 h-8"><title>é‡ã­ãŸã‚«ãƒ¼ãƒ‰ã®ã‚¢ã‚¤ã‚³ãƒ³</title><rect x="5" y="15" width="50" height="35" rx="5" fill="var(--icon-back-card-color)" stroke="currentColor" stroke-width="1.5"/><rect x="15" y="5" width="50" height="35" rx="5" fill="var(--card-bg-color)" stroke="currentColor" stroke-width="1.5"/></svg>' : '<svg viewBox="0 0 70 60" class="w-8 h-8"><title>é¸æŠè‚¢ã‚°ãƒªãƒƒãƒ‰ã®ã‚¢ã‚¤ã‚³ãƒ³</title><rect x="10" y="5" width="22" height="22" rx="4" fill="var(--card-bg-color)" stroke="currentColor" stroke-width="1.5"/><rect x="38" y="5" width="22" height="22" rx="4" fill="var(--card-bg-color)" stroke="currentColor" stroke-width="1.5"/><rect x="10" y="33" width="22" height="22" rx="4" fill="var(--card-bg-color)" stroke="currentColor" stroke-width="1.5"/><g><rect x="38" y="33" width="22" height="22" rx="4" fill="var(--success-color)"/><path d="M44 44 l4 4 l8 -8" stroke="var(--primary-text-color)" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/></g></svg>'; }
        const updateDirectionButton = () => { dom.toggleDirection.innerHTML = state.uiSettings.cardDirection === 'front' ? `<svg viewBox="0 0 100 100" class="w-12 h-12"><title>è¡¨ã‹ã‚‰è£ã¸</title><rect x="15" y="15" width="50" height="50" rx="5" fill="var(--card-bg-color)" stroke="var(--text-color-secondary)" stroke-width="2"/><rect x="60" y="60" width="35" height="35" rx="3" fill="var(--icon-back-card-color)" stroke="var(--text-color-secondary)" stroke-width="1.5"/><g><path d="M 65 40 L 72.5 40 A 5 5 0 0 1 77.5 45 L 77.5 57" stroke="var(--card-bg-color)" stroke-width="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/><path d="M 74 57 L 77.5 60 L 81 57" stroke="var(--card-bg-color)" stroke-width="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/></g><g><path d="M 65 40 L 72.5 40 A 5 5 0 0 1 77.5 45 L 77.5 57" stroke="var(--text-color-secondary)" stroke-width="4" fill="none" stroke-linecap="round" stroke-linejoin="round"/><path d="M 74 57 L 77.5 60 L 81 57" fill="none" stroke="var(--text-color-secondary)" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/></g></svg>` : `<svg viewBox="0 0 100 100" class="w-12 h-12"><title>è£ã‹ã‚‰è¡¨ã¸</title><rect x="15" y="15" width="50" height="50" rx="5" fill="var(--icon-back-card-color)" stroke="var(--text-color-secondary)" stroke-width="2"/><rect x="60" y="60" width="35" height="35" rx="3" fill="var(--card-bg-color)" stroke="var(--text-color-secondary)" stroke-width="1.5"/><g><path d="M 60 77.5 L 45 77.5 A 5 5 0 0 1 40 72.5 L 40 68" stroke="var(--card-bg-color)" stroke-width="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/><path d="M 36.5 68 L 40 65 L 43.5 68" stroke="var(--card-bg-color)" stroke-width="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/></g><g><path d="M 60 77.5 L 45 77.5 A 5 5 0 0 1 40 72.5 L 40 68" stroke="var(--text-color-secondary)" stroke-width="4" fill="none" stroke-linecap="round" stroke-linejoin="round"/><path d="M 36.5 68 L 40 65 L 43.5 68" fill="none" stroke="var(--text-color-secondary)" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/></g></svg>`; }
        
        const escapeHTML = (str) => typeof str === 'string' ? str.replace(/[&<>"']/g, match => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[match])) : '';
        
        const renderDecks = (decks) => {
             dom.deckGrid.innerHTML = '';
             const term = dom.searchBar.value.toLowerCase();
             const filtered = decks.filter(d => d.title.toLowerCase().includes(term));
             if (filtered.length === 0) {
                 dom.deckGrid.innerHTML = `<p class="text-[var(--text-color-secondary)] col-span-full">å˜èªå¸³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>`;
                 return;
             }
             filtered.forEach(deck => {
                 const progress = deck.progress || 0;
                 const el = document.createElement('div');
                 el.className = 'bg-[var(--card-bg-color)] rounded-lg p-4 shadow-md flex flex-col justify-between cursor-pointer';
                 el.innerHTML = `<div><h3 class="font-bold text-md mb-2 truncate">${escapeHTML(deck.title)}</h3><div class="w-full bg-gray-200 rounded-full h-2.5"><div class="bg-[var(--primary-color)] h-2.5 rounded-full" style="width: ${progress}%"></div></div></div><div class="flex justify-between items-center text-sm text-[var(--text-color-secondary)]"><span>é€²æ—: ${progress}%</span><button data-deck-id="${deck.id}" class="play-button text-xl text-[var(--primary-color)] font-bold">â–¶</button></div>`;
                 el.querySelector('.play-button').addEventListener('click', (e) => { e.stopPropagation(); startLearningSession(deck.id, 'all'); });
                 el.addEventListener('click', () => showDeckScreen(deck.id, deck.title));
                 dom.deckGrid.appendChild(el);
             });
        }

        const refreshDecks = async () => {
            const decks = await dbOps.getDecks();
            state.allDecksCache = decks.sort((a, b) => b.createdAt - a.createdAt);
            await updateRecommendationsAndProgress();
            renderDecks(state.allDecksCache);
        }

        const checkAndCreateSampleData = async () => {
            const decks = await dbOps.getDecks();
            if (decks.length === 0) {
                const deckId = await dbOps.addDeck({ title: 'åŸºæœ¬çš„ãªè‹±å˜èª', createdAt: Date.now(), progress: 0 });
                const sampleCards = [
                    { deckId, front: 'apple', back: 'ã‚Šã‚“ã”', createdAt: Date.now(), consecutiveCorrect: 0, nextReviewDate: Date.now(), nigatescore: 0, tags: ['#fruit'] },
                    { deckId, front: 'book', back: 'æœ¬', createdAt: Date.now(), consecutiveCorrect: 0, nextReviewDate: Date.now(), nigatescore: 0, tags: ['#noun'] },
                    { deckId, front: 'car', back: 'è»Š', createdAt: Date.now(), consecutiveCorrect: 0, nextReviewDate: Date.now(), nigatescore: 0, tags: ['#vehicle'] },
                    { deckId, front: 'dog', back: 'çŠ¬', createdAt: Date.now(), consecutiveCorrect: 0, nextReviewDate: Date.now(), nigatescore: 0, tags: ['#animal'] },
                    { deckId, front: 'egg', back: 'åµ', createdAt: Date.now(), consecutiveCorrect: 0, nextReviewDate: Date.now(), nigatescore: 0, tags: ['#food'] },
                ];
                for (const card of sampleCards) {
                    await dbOps.addCard(card);
                }
            }
        }
        
        const showDeckScreen = async (deckId, deckTitle) => {
            state.currentDeckId = deckId;
            dom.deckTitleHeader.textContent = deckTitle;
            state.currentDeckCards = await dbOps.getCardsByDeck(deckId);
            renderTagFilters();
            renderCards();
            showScreen('deck');
        }

        const renderCards = () => {
            dom.cardListContainer.innerHTML = '';
            if (state.currentDeckCards.length === 0) {
                dom.cardListContainer.innerHTML = `<p class="text-[var(--text-color-secondary)] text-center mt-8">å˜èªãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>`;
                return;
            }
            const filteredCards = state.currentTagFilter 
                ? state.currentDeckCards.filter(card => card.tags && card.tags.includes(state.currentTagFilter)) 
                : state.currentDeckCards;

            filteredCards.forEach(card => {
                const cardItem = document.createElement('div');
                cardItem.className = 'card-item bg-[var(--card-bg-color)] rounded-lg p-3 mb-3 shadow-sm';
                cardItem.dataset.cardId = card.id;
                cardItem.innerHTML = createCardView(card);
                dom.cardListContainer.appendChild(cardItem);
            });
        }

        const createCardView = (card) => {
            const tagsHtml = (card.tags || []).map(tag => `<span class="bg-gray-200 text-gray-700 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded">${escapeHTML(tag)}</span>`).join('');
            const history = (card.history || []).map(h => `<span class="inline-block w-3 h-3 rounded-full ${h ? 'bg-green-500' : 'bg-red-500'}"></span>`).join('');
            return `<div class="flex items-center"><div class="flex-1 border-r border-gray-200 pr-3 mr-3 cursor-pointer card-front-div"><div class="text-xs text-[var(--text-color-secondary)]">ã‚ªãƒ¢ãƒ†</div><div class="card-front-text font-medium">${escapeHTML(card.front)}</div></div><div class="flex-1 cursor-pointer card-back-div"><div class="text-xs text-[var(--text-color-secondary)]">ã‚¦ãƒ©</div><div class="card-back-text font-medium">${escapeHTML(card.back)}</div></div><div class="flex items-center gap-2 ml-2"><div class="flex gap-1">${history}</div><button class="edit-card-button text-lg hover:text-[var(--primary-color)]">âœï¸</button><button class="delete-card-button text-lg hover:text-[var(--danger-color)]">ğŸ—‘ï¸</button></div></div><div class="mt-2">${tagsHtml}</div>`;
        }
        
        const createCardEditView = (card) => {
             const tagsStr = (card.tags || []).join(', ');
            return `<div class="flex-1 flex flex-col gap-2"><input class="edit-front-input w-full px-2 py-1 border rounded" value="${escapeHTML(card.front)}"><input class="edit-back-input w-full px-2 py-1 border rounded" value="${escapeHTML(card.back)}"><input class="edit-tags-input w-full px-2 py-1 border rounded" placeholder="ã‚¿ã‚° (ä¾‹: #fruit, #food)" value="${escapeHTML(tagsStr)}"></div><div class="flex flex-col gap-2 ml-2"><button class="save-card-button text-lg hover:text-[var(--success-color)]">ğŸ’¾</button><button class="cancel-edit-button text-lg hover:text-[var(--danger-color)]">âŒ</button></div>`;
        };
        
        const startLearningSession = async (deckId, sessionType = 'all') => {
            let cards = await dbOps.getCardsByDeck(deckId);
            
            if (sessionType === 'review') {
                const now = Date.now();
                cards = cards.filter(c => (c.nextReviewDate || 0) <= now || (c.nigatescore || 0) >= 5);
            }

            if (state.currentTagFilter) {
                cards = cards.filter(card => card.tags && card.tags.includes(state.currentTagFilter));
            }
            
            cards.sort(() => Math.random() - 0.5);

            const count = parseInt(state.uiSettings.questionCount, 10);
            if (!isNaN(count) && cards.length > count) {
                cards = cards.slice(0, count);
            }

            if (cards.length === 0) {
                showToast("å­¦ç¿’ã™ã‚‹ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
                return;
            }
            if (state.uiSettings.learningMode === 'quiz' && cards.length < 4) {
                showToast("ã‚¯ã‚¤ã‚ºãƒ¢ãƒ¼ãƒ‰ã«ã¯æœ€ä½4æšã®ã‚«ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™ã€‚");
                return;
            }
            
            state.studySession.cards = cards;
            state.studySession.currentIndex = 0;
            state.studySession.correctAnswers = 0;
            state.studySession.deckId = deckId;
            
            showScreen('study');
            if (state.uiSettings.learningMode === 'card') {
                dom.flashcardMode.style.display = 'flex';
                dom.quizMode.style.display = 'none';
                showFlashcard();
            } else {
                 dom.flashcardMode.style.display = 'none';
                dom.quizMode.style.display = 'flex';
                showQuiz();
            }
        };

        const showFlashcard = () => {
            const flashcardEl = dom.flashcardInner.parentElement;
            flashcardEl.classList.remove('is-flipped');
             setTimeout(() => {
                if(state.studySession.currentIndex >= state.studySession.cards.length) return;
                const cardData = state.studySession.cards[state.studySession.currentIndex];
                if (!cardData) {
                    showNextCardOrFinish();
                    return;
                }
                const question = state.uiSettings.cardDirection === 'front' ? cardData.front : cardData.back;
                const answer = state.uiSettings.cardDirection === 'front' ? cardData.back : cardData.front;
                
                dom.flashcardFront.textContent = question;
                dom.flashcardBack.textContent = answer;
                dom.studyProgress.textContent = `${state.studySession.currentIndex + 1} / ${state.studySession.cards.length}`;
                speak(question);
            }, 300);
        };
        
        const showQuiz = () => {
            if(state.studySession.currentIndex >= state.studySession.cards.length) return;
            state.studySession.isAnswered = false;
            const quizQuestionEl = dom.quizQuestion;
            const quizOptionsEl = dom.quizOptions;

            const card = state.studySession.cards[state.studySession.currentIndex];
            if (!card) {
                showNextCardOrFinish();
                return;
            }
            const questionText = state.uiSettings.cardDirection === 'front' ? card.front : card.back;
            const correctAnswer = state.uiSettings.cardDirection === 'front' ? card.back : card.front;
            const options = state.studySession.cards
                .filter(c => c.id !== card.id)
                .map(c => state.uiSettings.cardDirection === 'front' ? c.back : c.front)
                .sort(() => 0.5 - Math.random())
                .slice(0, 3)
                .concat(correctAnswer)
                .sort(() => 0.5 - Math.random());
            
            quizQuestionEl.textContent = questionText;
            quizOptionsEl.innerHTML = '';
            options.forEach(text => {
                const button = document.createElement('button');
                button.className = "w-full p-4 bg-[var(--card-bg-color)] border-2 border-[var(--border-color)] rounded-lg text-lg font-semibold text-center hover:border-[var(--primary-color)] relative";
                button.textContent = text;
                button.onclick = (e) => handleQuizAnswer(e, text, correctAnswer);
                quizOptionsEl.appendChild(button);
            });
            dom.studyProgress.textContent = `${state.studySession.currentIndex + 1} / ${state.studySession.cards.length}`;
            state.studySession.startTime = Date.now();
            speak(questionText);
        };

        const handleQuizAnswer = (e, selected, correct) => {
            e.stopPropagation();
            if (state.studySession.isAnswered) {
                return;
            }
            state.studySession.isAnswered = true;

            const quizOptionsEl = dom.quizOptions;
             Array.from(quizOptionsEl.children).forEach(btn => {
                const isCorrect = btn.textContent === correct;
                const isSelected = btn.textContent === selected;
                btn.disabled = true;
                if (isCorrect) {
                    btn.classList.add('border-[var(--success-color)]', 'bg-[var(--success-bg-color)]');
                    btn.innerHTML += '<span class="absolute right-4 top-1/2 -translate-y-1/2 text-2xl text-[var(--success-color)]">âœ”</span>';
                }
                if (isSelected && !isCorrect) {
                    btn.classList.add('border-[var(--danger-color)]', 'bg-[var(--danger-bg-color)]');
                    btn.innerHTML += '<span class="absolute right-4 top-1/2 -translate-y-1/2 text-2xl text-[var(--danger-color)]">âœ–</span>';
                }
            });
            const wasCorrect = selected === correct;
            if (wasCorrect && state.uiSettings.quizAnswerReadAloud) {
                speak(correct);
            }
            processCardResult(wasCorrect);
        };

        const processCardResult = async (wasCorrect) => {
            if(wasCorrect && state.uiSettings.learningMode === 'quiz') {
                state.studySession.correctAnswers++;
            }
            const card = state.studySession.cards[state.studySession.currentIndex];
            if (!card) return;
            let scoreChange = 0;
            if (state.uiSettings.learningMode === 'quiz') {
                const time = (Date.now() - state.studySession.startTime) / 1000;
                if(!wasCorrect) scoreChange = 5;
                else if (time > 3) scoreChange = 2;
                else scoreChange = -1;
            } else {
                 scoreChange = wasCorrect ? -1 : 3;
            }
            
            card.consecutiveCorrect = wasCorrect ? (card.consecutiveCorrect || 0) + 1 : 0;
            card.nigatescore = Math.max(0, (card.nigatescore || 0) + scoreChange);
            const interval = wasCorrect ? Math.pow(2, Math.max(0, card.consecutiveCorrect - 1)) : 1;
            card.nextReviewDate = Date.now() + interval * 24 * 60 * 60 * 1000;
            
            card.history = [wasCorrect, ...(card.history || [])].slice(0, 3);
            
            await dbOps.updateCard(card);

            if (state.uiSettings.learningMode === 'card') {
                 setTimeout(() => showNextCardOrFinish(), 200);
            }
        };
        
        const showNextCardOrFinish = async () => {
            state.studySession.currentIndex++;
            if (state.studySession.currentIndex >= state.studySession.cards.length) {
                if (state.uiSettings.learningMode === 'quiz') {
                    const { length } = state.studySession.cards;
                    const { correctAnswers } = state.studySession;
                    const accuracy = length > 0 ? Math.round((correctAnswers / length) * 100) : 0;
                    showToast(`ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†ï¼ æ­£è§£ç‡: ${accuracy}%`);
                } else {
                    showToast(`ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†ï¼`);
                }
                await refreshDecks();
                showScreen('home');
            } else {
                state.uiSettings.learningMode === 'card' ? showFlashcard() : showQuiz();
            }
        };

        const updateRecommendationsAndProgress = async () => {
            const allCards = await dbOps.getAllCards();
            const now = Date.now();
            
            const reviewCardsByDeck = {};
            const nigateCardsByDeck = {};
            const progressData = {};

            for (const card of allCards) {
                if (!progressData[card.deckId]) {
                    progressData[card.deckId] = { mastered: 0, total: 0 };
                }
                progressData[card.deckId].total++;
                if ((card.consecutiveCorrect || 0) >= 3) {
                    progressData[card.deckId].mastered++;
                }

                if ((card.nextReviewDate || 0) <= now) {
                    if(!reviewCardsByDeck[card.deckId]) reviewCardsByDeck[card.deckId] = 0;
                    reviewCardsByDeck[card.deckId]++;
                }
                if ((card.nigatescore || 0) >= 5) {
                    if(!nigateCardsByDeck[card.deckId]) nigateCardsByDeck[card.deckId] = 0;
                    nigateCardsByDeck[card.deckId]++;
                }
            }
            
            for (const deck of state.allDecksCache) {
                const prog = progressData[deck.id];
                const newProgress = (prog && prog.total > 0) ? Math.round((prog.mastered / prog.total) * 100) : 0;
                if (deck.progress !== newProgress) {
                    deck.progress = newProgress;
                    await dbOps.updateDeck(deck);
                }
            }
            
            const recommendGrid = document.getElementById('recommend-grid');
            const recommendDeckIds = new Set([...Object.keys(reviewCardsByDeck).map(Number), ...Object.keys(nigateCardsByDeck).map(Number)]);

            recommendGrid.innerHTML = '';
            if (recommendDeckIds.size === 0) {
                recommendGrid.innerHTML = `<p class="text-[var(--text-color-secondary)] col-span-full">å¾©ç¿’ã™ã‚‹ã‚«ãƒ¼ãƒ‰ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>`;
                return;
            }

            recommendDeckIds.forEach(deckId => {
                const deck = state.allDecksCache.find(d => d.id === deckId);
                if (deck) {
                    const reviewCount = reviewCardsByDeck[deckId] || 0;
                    const nigateCount = nigateCardsByDeck[deckId] || 0;
                    let infoText = [];
                    if (reviewCount > 0) infoText.push(`å¾©ç¿’: ${reviewCount}æš`);
                    if (nigateCount > 0) infoText.push(`è‹¦æ‰‹: ${nigateCount}æš`);

                    const el = document.createElement('div');
                    el.className = 'bg-[var(--card-bg-color)] rounded-lg p-4 shadow-md cursor-pointer';
                    el.innerHTML = `<div class="font-bold text-md mb-2 truncate">${escapeHTML(deck.title)}</div><div class="text-sm text-[var(--text-color-secondary)]">${infoText.join(', ')}</div>`;
                    el.addEventListener('click', () => startLearningSession(deck.id, 'review'));
                    recommendGrid.appendChild(el);
                }
            });
        };
        
        const renderTagFilters = () => {
            const tagFilterBar = document.getElementById('tag-filter-bar');
            const allTags = new Set(state.currentDeckCards.flatMap(card => card.tags || []));
            tagFilterBar.innerHTML = '';
            
            const createButton = (text, tag) => {
                const button = document.createElement('button');
                button.textContent = text;
                button.dataset.tag = tag;
                const isActive = state.currentTagFilter === tag;
                button.className = `px-3 py-1 text-sm rounded-full ${isActive ? 'bg-[var(--primary-color)] text-[var(--primary-text-color)]' : 'bg-gray-200 text-gray-700'}`;
                return button;
            };

            tagFilterBar.appendChild(createButton('ã™ã¹ã¦è¡¨ç¤º', null));
            allTags.forEach(tag => tagFilterBar.appendChild(createButton(tag, tag)));
        };
        
        const detectLang = (text) => {
            const jpRegex = /[\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/;
            return jpRegex.test(text) ? 'ja-JP' : 'en-US';
        };

        const speak = (text) => {
            if (!state.uiSettings.speechEnabled || !('speechSynthesis' in window)) { return; }
            speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            const lang = detectLang(text);
            utterance.lang = lang;
            
            if (lang === 'ja-JP') {
                utterance.rate = state.uiSettings.jaRate;
                const voice = speechSynthesis.getVoices().find(v => v.name === state.uiSettings.jaVoice);
                if(voice) utterance.voice = voice;
            } else {
                utterance.rate = state.uiSettings.enRate;
                const voice = speechSynthesis.getVoices().find(v => v.name === state.uiSettings.enVoice);
                if(voice) utterance.voice = voice;
            }

            speechSynthesis.speak(utterance);
        };

        const populateVoiceList = () => {
            const enSelect = document.getElementById('en-voice-select');
            const jaSelect = document.getElementById('ja-voice-select');
            enSelect.innerHTML = '';
            jaSelect.innerHTML = '';

            const voices = speechSynthesis.getVoices();
            voices.forEach(voice => {
                const option = document.createElement('option');
                option.textContent = `${voice.name} (${voice.lang})`;
                option.value = voice.name;
                if (voice.lang.startsWith('en')) {
                    enSelect.appendChild(option);
                } else if (voice.lang.startsWith('ja')) {
                    jaSelect.appendChild(option);
                }
            });
            if (state.uiSettings.enVoice) enSelect.value = state.uiSettings.enVoice;
            if (state.uiSettings.jaVoice) jaSelect.value = state.uiSettings.jaVoice;
        };
        
        const setupSlidingPillControl = (containerId, settingKey, onUpdate) => {
            const control = document.getElementById(containerId);
            if (!control) return;

            const pill = control.querySelector('.pill');
            const options = control.querySelectorAll('.option');

            const movePill = (target) => {
                if (!target || !pill) return;
                pill.style.left = `${target.offsetLeft}px`;
                pill.style.width = `${target.offsetWidth}px`;
                options.forEach(o => o.classList.remove('selected'));
                target.classList.add('selected');
            };

            options.forEach(option => {
                option.addEventListener('click', () => {
                    const value = option.dataset.value;
                    saveSetting(settingKey, value);
                    movePill(option);
                    if (onUpdate) onUpdate();
                });
            });
        };

        const updateSettingsUI = () => {
            document.getElementById('speech-enabled-toggle').checked = state.uiSettings.speechEnabled;
            document.getElementById('quiz-answer-speak-toggle').checked = state.uiSettings.quizAnswerReadAloud;
            document.getElementById('en-rate-slider').value = state.uiSettings.enRate;
            document.getElementById('en-rate-value').textContent = state.uiSettings.enRate;
            document.getElementById('ja-rate-slider').value = state.uiSettings.jaRate;
            document.getElementById('ja-rate-value').textContent = state.uiSettings.jaRate;
            
            requestAnimationFrame(() => {
                const themeOption = document.querySelector(`#theme-selector .option[data-value="${state.uiSettings.theme}"]`);
                if(themeOption) {
                    const control = document.getElementById('theme-selector');
                    const pill = control.querySelector('.pill');
                    pill.style.left = `${themeOption.offsetLeft}px`;
                    pill.style.width = `${themeOption.offsetWidth}px`;
                    control.querySelectorAll('.option').forEach(o => o.classList.remove('selected'));
                    themeOption.classList.add('selected');
                }

                const countOption = document.querySelector(`#question-count-buttons .option[data-value="${state.uiSettings.questionCount}"]`);
                if(countOption) {
                    const control = document.getElementById('question-count-buttons');
                    const pill = control.querySelector('.pill');
                    pill.style.left = `${countOption.offsetLeft}px`;
                    pill.style.width = `${countOption.offsetWidth}px`;
                    control.querySelectorAll('.option').forEach(o => o.classList.remove('selected'));
                    countOption.classList.add('selected');
                }
            });
            
            const speechSubPanel = document.querySelector('#speech-settings-card .sub-settings-panel');
            speechSubPanel.classList.toggle('active', state.uiSettings.speechEnabled);

            populateVoiceList();
        };

        const showConfirmModal = (title, onConfirm) => {
            const modal = document.getElementById('confirm-modal');
            modal.querySelector('#confirm-modal-title').textContent = title;
            modal.classList.remove('opacity-0', 'pointer-events-none');

            const okButton = modal.querySelector('#confirm-modal-ok');
            const cancelButton = modal.querySelector('#confirm-modal-cancel');

            const close = () => modal.classList.add('opacity-0', 'pointer-events-none');

            okButton.onclick = () => {
                onConfirm();
                close();
            };
            cancelButton.onclick = close;
        }

        const handleCsvImport = async (file) => {
            if (!state.currentDeckId) return showToast("å˜èªå¸³ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
            Papa.parse(file, {
                complete: async (results) => {
                    let importedCount = 0;
                    for (const row of results.data) {
                        const front = row[0] && row[0].trim();
                        const back = row[1] && row[1].trim();
                        if (front && back) {
                            await dbOps.addCard({ deckId: state.currentDeckId, front, back, createdAt: Date.now(), consecutiveCorrect: 0, nextReviewDate: Date.now(), nigatescore: 0, tags: [] });
                            importedCount++;
                        }
                    }
                    if (importedCount > 0) {
                        showToast(`${importedCount} ä»¶ã®å˜èªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚`);
                        state.currentDeckCards = await dbOps.getCardsByDeck(state.currentDeckId);
                        renderCards();
                        renderTagFilters();
                    } else {
                        showToast("ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§ãã‚‹æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚", 4000);
                    }
                }
            });
        }
        
        function initDOMElements() {
            Object.assign(dom, {
                screens: { home: document.getElementById('home-screen'), deck: document.getElementById('deck-screen'), study: document.getElementById('study-screen'), settings: document.getElementById('settings-screen') },
                deckLoading: document.getElementById('deck-loading'),
                deckGrid: document.getElementById('deck-grid'),
                searchBar: document.getElementById('search-bar'),
                deckTitleHeader: document.getElementById('deck-title-header'),
                cardListContainer: document.getElementById('card-list-container'),
                addCardForm: document.getElementById('add-card-form'),
                newCardFrontInput: document.getElementById('new-card-front'),
                newCardBackInput: document.getElementById('new-card-back'),
                addDeckModal: document.getElementById('add-deck-modal'),
                newDeckTitleInput: document.getElementById('new-deck-title-input'),
                flashcardInner: document.getElementById('flashcard-inner'),
                flashcardFront: document.getElementById('flashcard-front'),
                flashcardBack: document.getElementById('flashcard-back'),
                studyProgress: document.getElementById('study-progress'),
                flashcardMode: document.getElementById('flashcard-mode'),
                quizMode: document.getElementById('quiz-mode'),
                flashcardControls: document.getElementById('flashcard-controls'),
                quizQuestion: document.getElementById('quiz-question'),
                quizOptions: document.getElementById('quiz-options'),
                toggleMode: document.getElementById('toggle-mode'),
                toggleDirection: document.getElementById('toggle-direction'),
            });
        }
        
        function setupEventListeners() {
            document.getElementById('add-deck-button').addEventListener('click', () => dom.addDeckModal.classList.remove('opacity-0', 'pointer-events-none'));
            document.getElementById('cancel-add-deck').addEventListener('click', () => dom.addDeckModal.classList.add('opacity-0', 'pointer-events-none'));
            document.getElementById('confirm-add-deck').addEventListener('click', async () => {
                const title = dom.newDeckTitleInput.value.trim();
                if (title) {
                    await dbOps.addDeck({ title, createdAt: Date.now(), progress: 0 });
                    await refreshDecks();
                    dom.newDeckTitleInput.value = '';
                    dom.addDeckModal.classList.add('opacity-0', 'pointer-events-none');
                }
            });
            
            document.getElementById('back-to-home-button').addEventListener('click', () => { refreshDecks(); showScreen('home'); });
            document.getElementById('exit-study-button').addEventListener('click', async () => { await refreshDecks(); showScreen('home'); });
            document.getElementById('settings-button').addEventListener('click', () => { showScreen('settings'); updateSettingsUI(); });
            document.getElementById('back-to-home-from-settings').addEventListener('click', () => showScreen('home'));
            dom.searchBar.addEventListener('input', () => renderDecks(state.allDecksCache));
            
            dom.addCardForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const front = dom.newCardFrontInput.value.trim();
                const back = dom.newCardBackInput.value.trim();
                if (front && back && state.currentDeckId) {
                    await dbOps.addCard({ deckId: state.currentDeckId, front, back, createdAt: Date.now(), consecutiveCorrect: 0, nextReviewDate: Date.now(), nigatescore: 0, tags: [] });
                    state.currentDeckCards = await dbOps.getCardsByDeck(state.currentDeckId);
                    renderCards();
                    renderTagFilters();
                    dom.addCardForm.reset();
                    dom.newCardFrontInput.focus();
                }
            });

            dom.cardListContainer.addEventListener('click', async (e) => {
                 const cardItem = e.target.closest('.card-item');
                if (!cardItem) return;
                const cardId = Number(cardItem.dataset.cardId);

                if (e.target.closest('.delete-card-button')) {
                    showConfirmModal("ã“ã®ã‚«ãƒ¼ãƒ‰ã‚’æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ", async () => {
                        await dbOps.deleteCard(cardId);
                        state.currentDeckCards = await dbOps.getCardsByDeck(state.currentDeckId);
                        renderCards();
                        renderTagFilters();
                    });
                } 
                else if(e.target.closest('.edit-card-button')) {
                    const card = await dbOps.getCard(cardId);
                    cardItem.innerHTML = createCardEditView(card);
                }
                else if (e.target.closest('.save-card-button')) {
                    const card = await dbOps.getCard(cardId);
                    card.front = cardItem.querySelector('.edit-front-input').value.trim();
                    card.back = cardItem.querySelector('.edit-back-input').value.trim();
                    const tagsStr = cardItem.querySelector('.edit-tags-input').value.trim();
                    card.tags = tagsStr.split(',').map(t => t.trim().replace(/^#/, '')).filter(Boolean).map(t => `#${t}`);
                    await dbOps.updateCard(card);
                    state.currentDeckCards = await dbOps.getCardsByDeck(state.currentDeckId);
                    renderCards();
                    renderTagFilters();
                }
                else if (e.target.closest('.cancel-edit-button')) {
                    const card = await dbOps.getCard(cardId);
                    cardItem.innerHTML = createCardView(card);
                }
                else if (e.target.closest('.card-front-div')) {
                    speak(e.target.closest('.card-front-text').textContent);
                }
                else if (e.target.closest('.card-back-div')) {
                    speak(e.target.closest('.card-back-text').textContent);
                }
            });

            document.getElementById('delete-deck-button').addEventListener('click', async () => {
                 showConfirmModal("ã“ã®å˜èªå¸³ã¨ä¸­ã®ã™ã¹ã¦ã®ã‚«ãƒ¼ãƒ‰ã‚’æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ", async () => {
                    if (state.currentDeckId) {
                        await dbOps.deleteDeck(state.currentDeckId);
                        await refreshDecks();
                        showScreen('home');
                    }
                });
            });

            document.getElementById('csv-import-button').addEventListener('click', () => {
                document.getElementById('csv-file-input').click();
            });
            document.getElementById('csv-file-input').addEventListener('change', (e) => {
                if(e.target.files.length > 0) handleCsvImport(e.target.files[0]);
                e.target.value = '';
            });

            dom.toggleMode.addEventListener('click', () => {
                saveSetting('learningMode', state.uiSettings.learningMode === 'card' ? 'quiz' : 'card');
                updateModeButton();
            });
            dom.toggleDirection.addEventListener('click', () => {
                saveSetting('cardDirection', state.uiSettings.cardDirection === 'front' ? 'back' : 'front');
                updateDirectionButton();
            });
            
            dom.flashcardInner.addEventListener('click', (e) => {
                e.currentTarget.parentElement.classList.toggle('is-flipped');
            });
            document.getElementById('quiz-question').addEventListener('click', (e) => speak(e.target.textContent));
            document.getElementById('study-screen').addEventListener('click', (e) => {
                if(state.uiSettings.learningMode === 'quiz' && state.studySession.isAnswered) {
                    if (e.target.closest('#quiz-options button')) {
                        return;
                    }
                    showNextCardOrFinish();
                }
            });

            document.getElementById('familiar-button').addEventListener('click', () => processCardResult(true));
            document.getElementById('unfamiliar-button').addEventListener('click', () => processCardResult(false));
            document.getElementById('tag-filter-bar').addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (button) {
                    state.currentTagFilter = button.dataset.tag === 'null' ? null : button.dataset.tag;
                    renderCards();
                    renderTagFilters();
                }
            });

            // --- è¨­å®šç”»é¢ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ (ä¸€åº¦ã ã‘ç™»éŒ²) ---
            setupSlidingPillControl('theme-selector', 'theme', updateTheme);
            setupSlidingPillControl('question-count-buttons', 'questionCount');
            const speechToggle = document.getElementById('speech-enabled-toggle');
            const speechSubPanel = document.querySelector('#speech-settings-card .sub-settings-panel');
            speechToggle.addEventListener('change', (e) => {
                saveSetting('speechEnabled', e.target.checked);
                speechSubPanel.classList.toggle('active', e.target.checked);
            });

            document.querySelectorAll('#speech-settings-card .accordion-header').forEach(header => {
                header.addEventListener('click', () => {
                    if (speechSubPanel.classList.contains('active')) {
                        const content = document.getElementById(header.dataset.target);
                        header.classList.toggle('open');
                        content.classList.toggle('open');
                    }
                });
            });

            document.getElementById('quiz-answer-speak-toggle').addEventListener('change', (e) => saveSetting('quizAnswerReadAloud', e.target.checked));
            document.getElementById('en-voice-select').addEventListener('change', (e) => saveSetting('enVoice', e.target.value));
            document.getElementById('ja-voice-select').addEventListener('change', (e) => saveSetting('jaVoice', e.target.value));
            document.getElementById('en-rate-slider').addEventListener('input', (e) => {
                saveSetting('enRate', parseFloat(e.target.value));
                document.getElementById('en-rate-value').textContent = e.target.value;
            });
             document.getElementById('ja-rate-slider').addEventListener('input', (e) => {
                saveSetting('jaRate', parseFloat(e.target.value));
                document.getElementById('ja-rate-value').textContent = e.target.value;
            });
        }
        
        async function initializeApp() {
            initDOMElements();
            setupEventListeners();
            loadSettings();
            
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = populateVoiceList;
            } else {
                populateVoiceList();
            }
            try {
                await dbOps.initDB();
                await checkAndCreateSampleData();
                await refreshDecks();
                dom.deckLoading.style.display = 'none';
            } catch (error) {
                console.error("ã‚¢ãƒ—ãƒªã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
                dom.deckLoading.textContent = "ã‚¢ãƒ—ãƒªã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
                dom.deckLoading.style.color = 'red';
            }
        }
    </script>
</body>
</html>
